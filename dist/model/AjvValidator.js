var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else{obj[key]=value;}return obj;}function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++){arr2[i]=arr[i];}return arr2;}else{return Array.from(arr);}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&(typeof call==="object"||typeof call==="function")?call:self;}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}var Validator=require('./Validator');var _require=require('../model/ValidationError'),ValidationErrorType=_require.Type;var _require2=require('../utils/objectUtils'),isObject=_require2.isObject,once=_require2.once,lodashCloneDeep=_require2.cloneDeep,omit=_require2.omit;var getAjv=once(function(){try{return require('ajv');}catch(err){throw new Error('Optional ajv dependency not installed. Please run `npm install ajv --save`');}});var AjvValidator=function(_Validator){_inherits(AjvValidator,_Validator);function AjvValidator(conf){_classCallCheck(this,AjvValidator);var _this=_possibleConstructorReturn(this,(AjvValidator.__proto__||Object.getPrototypeOf(AjvValidator)).call(this));_this.ajvOptions=_extends({errorDataPath:'property'},conf.options,{allErrors:true});_this.ajv=new getAjv()(_extends({useDefaults:true},_this.ajvOptions));_this.ajvNoDefaults=new getAjv()(_extends({},_this.ajvOptions,{useDefaults:false}));_this.cache=new Map();conf.onCreateAjv(_this.ajv);conf.onCreateAjv(_this.ajvNoDefaults);return _this;}_createClass(AjvValidator,[{key:'beforeValidate',value:function beforeValidate(_ref){var json=_ref.json,model=_ref.model,options=_ref.options,ctx=_ref.ctx;ctx.jsonSchema=model.constructor.getJsonSchema();if(model.$beforeValidate!==model.$objectionModelClass.prototype.$beforeValidate){ctx.jsonSchema=cloneDeep(ctx.jsonSchema);var ret=model.$beforeValidate(ctx.jsonSchema,json,options);if(ret!==undefined){ctx.jsonSchema=ret;}}}},{key:'validate',value:function validate(_ref2){var json=_ref2.json,model=_ref2.model,options=_ref2.options,ctx=_ref2.ctx;if(!ctx.jsonSchema){return json;}var modelClass=model.constructor;var validator=this.getValidator(modelClass,ctx.jsonSchema,!!options.patch);if(!options.mutable&&!options.patch&&setsDefaultValues(ctx.jsonSchema)){json=cloneDeep(json);}validator.call(model,json);var error=parseValidationError(validator.errors,modelClass,options);if(error){throw error;}return json;}},{key:'getValidator',value:function getValidator(modelClass,jsonSchema,isPatchObject){var createCacheKey=this.ajvOptions.serialize||JSON.stringify;var cacheKey=jsonSchema===modelClass.getJsonSchema()?modelClass.uniqueTag():createCacheKey(jsonSchema);var validators=this.cache.get(cacheKey);var validator=null;if(!validators){validators={patchValidator:null,normalValidator:null};this.cache.set(cacheKey,validators);}if(isPatchObject){validator=validators.patchValidator;if(!validator){validator=this.compilePatchValidator(jsonSchema);validators.patchValidator=validator;}}else{validator=validators.normalValidator;if(!validator){validator=this.compileNormalValidator(jsonSchema);validators.normalValidator=validator;}}return validator;}},{key:'compilePatchValidator',value:function compilePatchValidator(jsonSchema){jsonSchema=jsonSchemaWithoutRequired(jsonSchema);return this.ajvNoDefaults.compile(jsonSchema);}},{key:'compileNormalValidator',value:function compileNormalValidator(jsonSchema){return this.ajv.compile(jsonSchema);}}]);return AjvValidator;}(Validator);function parseValidationError(errors,modelClass,options){if(!errors){return null;}var relations=modelClass.getRelations();var errorHash={};var numErrors=0;for(var i=0;i<errors.length;++i){var error=errors[i];var dataPath=''+(options.dataPath||'')+error.dataPath;if(error.params&&error.params.additionalProperty&&relations[error.params.additionalProperty]){continue;}var key=dataPath.replace(/\['([^' ]*)'\]/g,'.$1').substring(1);var array=errorHash[key]||(errorHash[key]=[]);array.unshift({message:error.message,keyword:error.keyword,params:error.params});++numErrors;}if(numErrors===0){return null;}return modelClass.createValidationError({type:ValidationErrorType.ModelValidation,data:errorHash});}function cloneDeep(obj){if(isObject(obj)&&obj.$isObjectionModel){return obj.$clone();}else{return lodashCloneDeep(obj);}}function setsDefaultValues(jsonSchema){return jsonSchema&&jsonSchema.properties&&hasDefaults(jsonSchema.properties);}function hasDefaults(obj){if(Array.isArray(obj)){return arrayHasDefaults(obj);}else{return objectHasDefaults(obj);}}function arrayHasDefaults(arr){for(var i=0,l=arr.length;i<l;++i){var val=arr[i];if(isObject(val)&&hasDefaults(val)){return true;}}return false;}function objectHasDefaults(obj){var keys=Object.keys(obj);for(var i=0,l=keys.length;i<l;++i){var key=keys[i];if(key==='default'){return true;}else{var val=obj[key];if(isObject(val)&&hasDefaults(val)){return true;}}}return false;}function jsonSchemaWithoutRequired(jsonSchema){var subSchemaProps=['anyOf','oneOf','allOf','not','then','else'];return Object.assign.apply(Object,[omit(jsonSchema,['required'].concat(subSchemaProps))].concat(_toConsumableArray(subSchemaProps.map(function(prop){return subSchemaWithoutRequired(jsonSchema,prop);}))));}function subSchemaWithoutRequired(jsonSchema,prop){if(jsonSchema[prop]){if(Array.isArray(jsonSchema[prop])){var schemaArray=jsonSchemaArrayWithoutRequired(jsonSchema[prop]);if(schemaArray.length!==0){return _defineProperty({},prop,schemaArray);}else{return{};}}else{return _defineProperty({},prop,jsonSchemaWithoutRequired(jsonSchema[prop]));}}else{return{};}}function jsonSchemaArrayWithoutRequired(jsonSchemaArray){return jsonSchemaArray.map(jsonSchemaWithoutRequired).filter(isNotEmptyObject);}function isNotEmptyObject(obj){return Object.keys(obj).length!==0;}module.exports=AjvValidator;