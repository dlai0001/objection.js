var _slicedToArray=function(){function sliceIterator(arr,i){var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[typeof Symbol==='function'?Symbol.iterator:'@@iterator'](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break;}}catch(err){_d=true;_e=err;}finally{try{if(!_n&&_i["return"])_i["return"]();}finally{if(_d)throw _e;}}return _arr;}return function(arr,i){if(Array.isArray(arr)){return arr;}else if((typeof Symbol==='function'?Symbol.iterator:'@@iterator')in Object(arr)){return sliceIterator(arr,i);}else{throw new TypeError("Invalid attempt to destructure non-iterable instance");}};}();var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var _require=require('../../utils/dataPath'),appendDataPath=_require.appendDataPath;var _require2=require('../../model/ValidationError'),ValidationErrorType=_require2.Type;var _require3=require('../../utils/objectUtils'),isObject=_require3.isObject,last=_require3.last,isString=_require3.isString;var HasManyRelation=require('../../relations/hasMany/HasManyRelation');var ManyToManyRelation=require('../../relations/manyToMany/ManyToManyRelation');var BelongsToOneRelation=require('../../relations/belongsToOne/BelongsToOneRelation');var DependencyNode=require('./DependencyNode');var HasManyDependency=require('./HasManyDependency');var ManyToManyConnection=require('./ManyToManyConnection');var ReplaceValueDependency=require('./ReplaceValueDependency');var BelongsToOneDependency=require('./BelongsToOneDependency');var InterpolateValueDependency=require('./InterpolateValueDependency');var DependencyGraph=function(){function DependencyGraph(opt,allowedRelations){_classCallCheck(this,DependencyGraph);this.allowedRelations=allowedRelations;this.nodesById=new Map();this.nodes=[];this.uid=0;this.opt=opt||Object.create(null);}_createClass(DependencyGraph,[{key:'build',value:function build(modelClass,models){this.nodesById=new Map();this.nodes=[];if(Array.isArray(models)){for(var i=0,l=models.length;i<l;++i){this.buildForModel({modelClass:modelClass,model:models[i],parentModel:null,allowedRelations:this.allowedRelations,dataPath:null,rel:null});}}else{this.buildForModel({modelClass:modelClass,model:models,parentModel:null,allowedRelations:this.allowedRelations,dataPath:null,rel:null});}this.solveReferences();this.createNonRelationDeps();return this.nodes;}},{key:'hasCyclicReferences',value:function hasCyclicReferences(){return this.isCyclic(this.nodes);}},{key:'buildForModel',value:function buildForModel(_ref){var modelClass=_ref.modelClass,model=_ref.model,parentNode=_ref.parentNode,rel=_ref.rel,allowedRelations=_ref.allowedRelations,dataPath=_ref.dataPath;if(!model||!model.$isObjectionModel){throw modelClass.createValidationError({type:ValidationErrorType.InvalidGraph,message:'not a model'});}if(!model[modelClass.uidProp]){model[modelClass.uidProp]=this.createUid();}var node=new DependencyNode({parentNode:parentNode,model:model,modelClass:modelClass,relation:rel,dataPath:dataPath});var isRelate=this.isRelate({modelClass:modelClass,model:model,parentNode:parentNode,rel:rel});var dbRef=model[modelClass.dbRefProp];this.nodesById.set(node.id,node);this.nodes.push(node);if(isRelate&&dbRef){var isComposite=Array.isArray(dbRef);for(var i=0;i<rel.relatedProp.size;++i){rel.relatedProp.setProp(model,i,isComposite?dbRef[i]:dbRef);}}if(rel){if(rel instanceof HasManyRelation){node.needs.push(new HasManyDependency(parentNode,rel));parentNode.isNeededBy.push(new HasManyDependency(node,rel));if(isRelate){throw new Error('You cannot relate HasManyRelation or HasOneRelation using insertGraph, because those require update operations. Consider using upsertGraph instead.');}}else if(rel instanceof BelongsToOneRelation){node.isNeededBy.push(new BelongsToOneDependency(parentNode,rel));parentNode.needs.push(new BelongsToOneDependency(node,rel));if(isRelate){last(node.isNeededBy).resolve(model);}}else if(rel instanceof ManyToManyRelation){parentNode.manyToManyConnections.push(new ManyToManyConnection(node,rel));}}if(isRelate){node.markAsInserted();}this.buildForRelations({modelClass:modelClass,node:node,allowedRelations:allowedRelations,dataPath:dataPath});}},{key:'buildForRelations',value:function buildForRelations(_ref2){var modelClass=_ref2.modelClass,node=_ref2.node,allowedRelations=_ref2.allowedRelations,dataPath=_ref2.dataPath;var model=node.model;var relations=modelClass.getRelationArray();for(var i=0,l=relations.length;i<l;++i){var rel=relations[i];var relModels=model[rel.name];var nextAllowed=null;if(relModels){if(isObject(allowedRelations)&&allowedRelations.isObjectionRelationExpression){nextAllowed=allowedRelations.childExpression(rel.name);if(!nextAllowed){throw modelClass.createValidationError({type:ValidationErrorType.UnallowedRelation,message:'trying to insert an unallowed relation'});}}var relPath=appendDataPath(dataPath,rel);if(Array.isArray(relModels)){for(var _i=0,_l=relModels.length;_i<_l;++_i){this.buildForModel({modelClass:rel.relatedModelClass,model:relModels[_i],parentNode:node,rel:rel,allowedRelations:nextAllowed,dataPath:appendDataPath(relPath,_i)});}}else{this.buildForModel({model:relModels,modelClass:rel.relatedModelClass,parentNode:node,allowedRelations:nextAllowed,dataPath:relPath,rel:rel});}}}}},{key:'isRelate',value:function isRelate(_ref3){var modelClass=_ref3.modelClass,model=_ref3.model,parentNode=_ref3.parentNode,rel=_ref3.rel;if(!rel){return false;}if(model[modelClass.dbRefProp]){return true;}return rel.hasRelateProp(model)&&this.hasOption('relate',relationPath(parentNode,rel));}},{key:'hasOption',value:function hasOption(option,relationPath){var opt=this.opt[option];if(Array.isArray(opt)){return opt.indexOf(relationPath)!==-1;}else{return!!opt;}}},{key:'solveReferences',value:function solveReferences(){var refMap=new Map();this.mergeReferences(refMap);this.replaceReferenceNodes(refMap);}},{key:'mergeReferences',value:function mergeReferences(refMap){for(var n=0,ln=this.nodes.length;n<ln;++n){var refNode=this.nodes[n];var ref=void 0;if(refNode.handled){continue;}ref=refNode.model[refNode.modelClass.uidRefProp];if(ref){var actualNode=this.nodesById.get(ref);if(!actualNode){throw refNode.modelClass.createValidationError({type:ValidationErrorType.InvalidGraph,message:'could not resolve reference "'+ref+'"'});}for(var d=0,ld=refNode.needs.length;d<ld;++d){actualNode.needs.push(refNode.needs[d]);}for(var _d=0,_ld=refNode.isNeededBy.length;_d<_ld;++_d){actualNode.isNeededBy.push(refNode.isNeededBy[_d]);}for(var m=0,lm=refNode.manyToManyConnections.length;m<lm;++m){actualNode.manyToManyConnections.push(refNode.manyToManyConnections[m]);}refMap.set(refNode.id,actualNode);refNode.handled=true;}}}},{key:'replaceReferenceNodes',value:function replaceReferenceNodes(refMap){for(var n=0,ln=this.nodes.length;n<ln;++n){var node=this.nodes[n];var d=void 0,ld=void 0,dep=void 0,actualNode=void 0;for(d=0,ld=node.needs.length;d<ld;++d){dep=node.needs[d];actualNode=refMap.get(dep.node.id);if(actualNode){dep.node=actualNode;}}for(d=0,ld=node.isNeededBy.length;d<ld;++d){dep=node.isNeededBy[d];actualNode=refMap.get(dep.node.id);if(actualNode){dep.node=actualNode;}}for(var m=0,lm=node.manyToManyConnections.length;m<lm;++m){var conn=node.manyToManyConnections[m];actualNode=refMap.get(conn.node.id);if(actualNode){conn.refNode=conn.node;conn.node=actualNode;}}}}},{key:'createNonRelationDeps',value:function createNonRelationDeps(){for(var n=0,ln=this.nodes.length;n<ln;++n){var node=this.nodes[n];if(!node.handled){this.createNonRelationDepsForObject(node.model,node,[]);}}}},{key:'createNonRelationDepsForObject',value:function createNonRelationDepsForObject(obj,node,path){var _this=this;var propRefRegex=node.modelClass.propRefRegex;var relations=node.modelClass.getRelations();var isModel=obj&&obj.$isObjectionModel;var keys=Object.keys(obj);var _loop=function _loop(i,l){var key=keys[i];var value=obj[key];if(isModel&&relations[key]){return{v:void 0};}path.push(key);if(isString(value)){allMatches(propRefRegex,value,function(matchResult){var _matchResult=_slicedToArray(matchResult,3),match=_matchResult[0],refId=_matchResult[1],refProp=_matchResult[2];var refNode=_this.nodesById.get(refId);if(!refNode){throw node.modelClass.createValidationError({type:ValidationErrorType.InvalidGraph,message:'could not resolve reference "'+value+'"'});}if(value===match){node.needs.push(new ReplaceValueDependency(refNode,path,refProp,false));refNode.isNeededBy.push(new ReplaceValueDependency(node,path,refProp,true));}else{node.needs.push(new InterpolateValueDependency(refNode,path,refProp,match,false));refNode.isNeededBy.push(new InterpolateValueDependency(node,path,refProp,match,true));}});}else if(isObject(value)){_this.createNonRelationDepsForObject(value,node,path);}path.pop();};for(var i=0,l=keys.length;i<l;++i){var _ret=_loop(i,l);if(typeof _ret==="object")return _ret.v;}}},{key:'isCyclic',value:function isCyclic(nodes){var isCyclic=false;for(var n=0,ln=nodes.length;n<ln;++n){var node=nodes[n];if(node.handled){continue;}if(this.isCyclicNode(node)){isCyclic=true;break;}}this.clearFlags(this.nodes);return isCyclic;}},{key:'isCyclicNode',value:function isCyclicNode(node){if(!node.visited){node.visited=true;node.recursion=true;for(var d=0,ld=node.needs.length;d<ld;++d){var dep=node.needs[d];if(dep.node.handled){continue;}if(!dep.node.visited&&this.isCyclicNode(dep.node)){return true;}else if(dep.node.recursion){return true;}}}node.recursion=false;return false;}},{key:'clearFlags',value:function clearFlags(nodes){for(var n=0,ln=nodes.length;n<ln;++n){var node=nodes[n];node.visited=false;node.recursion=false;}}},{key:'createUid',value:function createUid(){return'__objection_uid('+ ++this.uid+')__';}}]);return DependencyGraph;}();function allMatches(regex,str,cb){var matchResult=regex.exec(str);while(matchResult){cb(matchResult);matchResult=regex.exec(str);}}function relationPath(parentNode,rel){var path='';while(parentNode!==null&&parentNode.relation!==null){path=parentNode.relation.name+(path?'.':'')+path;parentNode=parentNode.parentNode;}return path+(path?'.':'')+(rel?rel.name:'');}module.exports=DependencyGraph;