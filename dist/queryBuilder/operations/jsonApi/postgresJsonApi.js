var jsonFieldExpressionParser=require('../../parsers/jsonFieldExpressionParser');var _require=require('../../../utils/objectUtils'),asArray=_require.asArray,isObject=_require.isObject,isString=_require.isString;function parseFieldExpression(expression,extractAsText){var parsed=jsonFieldExpressionParser.parse(expression);var jsonRefs=parsed.access.map(function(it){return it.ref;}).join(',');var extractor=extractAsText?'#>>':'#>';var middleQuotedColumnName=parsed.columnName.split('.').join('"."');return'"'+middleQuotedColumnName+'"'+extractor+'\'{'+jsonRefs+'}\'';}function whereJsonbRefOnLeftJsonbValOrRefOnRight(builder,fieldExpression,operator,jsonObjectOrFieldExpression,queryPrefix){var queryParams=whereJsonbRefOnLeftJsonbValOrRefOnRightRawQueryParams(fieldExpression,operator,jsonObjectOrFieldExpression,queryPrefix);return builder.whereRaw.apply(builder,queryParams);}function whereJsonbRefOnLeftJsonbValOrRefOnRightRawQueryParams(fieldExpression,operator,jsonObjectOrFieldExpression,queryPrefix){var fieldReference=parseFieldExpression(fieldExpression);if(isString(jsonObjectOrFieldExpression)){var rightHandReference=parseFieldExpression(jsonObjectOrFieldExpression);var refRefQuery=['(',fieldReference,')::jsonb',operator,'(',rightHandReference,')::jsonb'];if(queryPrefix){refRefQuery.unshift(queryPrefix);}return[refRefQuery.join(' ')];}else if(isObject(jsonObjectOrFieldExpression)){var refValQuery=['(',fieldReference,')::jsonb',operator,'?::jsonb'];if(queryPrefix){refValQuery.unshift(queryPrefix);}return[refValQuery.join(' '),JSON.stringify(jsonObjectOrFieldExpression)];}throw new Error('Invalid right hand expression.');}function whereJsonFieldRightStringArrayOnLeftQuery(knex,fieldExpression,operator,keys){var fieldReference=parseFieldExpression(fieldExpression);keys=asArray(keys);var questionMarksArray=keys.map(function(key){if(!isString(key)){throw new Error('All keys to find must be strings.');}return'?';});var rawSqlTemplateString='array['+questionMarksArray.join(',')+']';var rightHandExpression=knex.raw(rawSqlTemplateString,keys);return fieldReference+' '+operator.replace('?','\\?')+' '+rightHandExpression;}function whereJsonFieldQuery(knex,fieldExpression,operator,value){var fieldReference=parseFieldExpression(fieldExpression,true);var normalizedOperator=normalizeOperator(knex,operator);var cast=void 0;var escapedValue=knex.raw(' ?',[value]);var type=typeof value;if(type==='number'){cast='::NUMERIC';}else if(type==='boolean'){cast='::BOOLEAN';}else if(type==='string'){cast='::TEXT';}else if(value===null){cast='::TEXT';escapedValue='NULL';}else{throw new Error('Value must be string, number, boolean or null.');}return'('+fieldReference+')'+cast+' '+normalizedOperator+' '+escapedValue;}function normalizeOperator(knex,operator){var trimmedLowerCase=operator.trim().toLowerCase();switch(trimmedLowerCase){case'is':case'is not':return trimmedLowerCase;default:return knex.client.formatter().operator(operator);}}module.exports={parseFieldExpression:parseFieldExpression,whereJsonbRefOnLeftJsonbValOrRefOnRight:whereJsonbRefOnLeftJsonbValOrRefOnRight,whereJsonbRefOnLeftJsonbValOrRefOnRightRawQueryParams:whereJsonbRefOnLeftJsonbValOrRefOnRightRawQueryParams,whereJsonFieldRightStringArrayOnLeftQuery:whereJsonFieldRightStringArrayOnLeftQuery,whereJsonFieldQuery:whereJsonFieldQuery};